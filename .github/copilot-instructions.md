# desuctools Copilot Instructions

## Project shape
- This repo is an **R package** focused on social survey processing for DESUC: recoding, tabulation, formatting, plotting, and API ingestion.
- Main package code lives in `R/`; exported surface is defined in `NAMESPACE` (generated by roxygen).
- Documentation pipeline is standard R package style: `README.Rmd -> README.md`, `R/*.R roxygen -> man/*.Rd + NAMESPACE`, pkg site in `docs/`.

## Architecture map (read these first)
- Survey tabulation core:
  - `R/tablas_output.R` for regular `data.frame`/`tibble` (`tabla_vars_segmentos()` generic + `.data.frame` method).
  - `R/tablas_survey.R` for complex survey designs (`svy_tabla_*`, and S3 integration with `tabla_vars_segmentos`).
- API clients:
  - SurveyToGo: `R/sg_get.R`, `R/sg_get_data.R`, `R/sg_date.R`.
  - Alchemer: `R/alchemer_functions.R` (`alch_get_*`, `alch_create_df`, `alch_read_spss`).
- Output/presentation:
  - `R/graficos_output.R` (`gg_bar_3_niveles_stack`).
  - `R/output_print.R` (`kable_desuc`, `tabla_columnas`, `frq_trunc`).
- Recoding/helpers:
  - `R/rec_variables.R`, `R/rec_labelled.R`, `R/rev_niveles.R`, `R/helpers_variables.R`.

## Developer workflows
- Run tests: `R -q -e "testthat::test_dir('tests/testthat')"` or `R -q -e "devtools::test()"`.
- Run package checks like CI: `R -q -e "rcmdcheck::rcmdcheck(args='--no-manual')"`.
- Regenerate docs/NAMESPACE after roxygen edits: `R -q -e "roxygen2::roxygenise()"`.
- Rebuild README from `README.Rmd`: `R -q -e "rmarkdown::render('README.Rmd')"`.
- Rebuild pkgdown site locally: `R -q -e "pkgdown::build_site()"`.
- Styling convention is `styler::style_pkg()` (see `.github/workflows/pr-commands.yaml`).

## Project-specific coding patterns
- Preserve **haven labels** and factor semantics in outputs. Many functions carry labels via `attr(x, 'label')` and convert with `forcats::as_factor`.
- APIs are a mix of tidy-eval and character-based selectors:
  - Public verbs often accept tidyselect in `.vars/.segmentos` (e.g., `tabla_vars_segmentos`).
  - Internal helpers usually receive column names as strings (`.var`, `.segmento`, `.wt`).
- Missing handling is explicit and domain-specific:
  - Missing categories are often promoted to explicit factor levels (`fct_na_value_to_level`).
  - `miss` controls valid-percentage columns (`prop_val`) in tabulation flows.
- Keep return shapes stable:
  - Tabulation outputs are expected to include `segmento_*`, `pregunta_*`, plus `casos/prop` (and optional CI or `prop_val`).

## Integration points and caveats
- Networked tests exist for SurveyToGo/Alchemer and rely on credentials (e.g., `SG_REST_API`, `SG_USER`, `SG_PASS`, `ALCHEMER_API_KEY`, `ALCHEMER_API_SECRET`); avoid assuming offline determinism.
- API wrappers use `httr2` with request throttling/retry (`sg_get`) and paginated aggregation (`alch_get_*` with `page = 'all'`).
- Data assets in `data/` are regenerated from scripts in `data-raw/` using `usethis::use_data(..., overwrite = TRUE)`.

## Change hygiene for this repo
- Edit source files, not generated artifacts unless intentionally regenerating:
  - Prefer editing `README.Rmd` over `README.md`.
  - Prefer editing `R/*.R` + roxygen comments, then regenerate `man/` and `NAMESPACE`.
- When changing tabulation behavior, update both test suites:
  - `tests/testthat/test-tablas_output.R` and `tests/testthat/test-tablas_survey.R`.
